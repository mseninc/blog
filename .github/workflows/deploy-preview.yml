name: Deploy preview

on:
  push:
    branches:
      - 'post/**'

jobs:
  preBuild:
    runs-on: ubuntu-latest
    
    outputs:
      preview: ${{ steps.setPreview.outputs.preview }}

    steps:

    - name: Git fetch
      run: |
        git init
        git remote add origin https://github.com/mseninc/blog.git
        git fetch --depth 1
        git branch -a

    - name: Prepare env PREVIEW
      id: setPreview
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        PREVIEW=`git -c core.quotepath=false diff origin/release origin/${BRANCH_NAME} --name-only | grep .md | head -n 1 | sed -E "s/.*\/([^/]+)\/[^./]+\.md$/\1/"`
        echo ::set-output name=preview::${PREVIEW}

  build:
    needs: preBuild
    if: ${{ needs.preBuild.outputs.preview != '' }}
    
    runs-on: ubuntu-latest
    
    env:
      AWS_DEFAULT_REGION: ap-northeast-1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      CONTENT_PATH: ${{ github.workspace }}/content
      GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES: true
    
    steps:
    
    - name: Prepare env PREVIEW
      run: echo "PREVIEW=${{ needs.preBuild.outputs.preview }}" >> $GITHUB_ENV

    - name: Prepare env BRANCH_NAME
      run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

    - name: Prepare env PATH_PREFIX
      run: echo "PATH_PREFIX=/${BRANCH_NAME}" >> $GITHUB_ENV
        
    - name: Prepare env url
      run: echo "url=https://preview.msen.blog/${BRANCH_NAME}/${PREVIEW}" >> $GITHUB_ENV

    - name: Checkout
      uses: actions/checkout@v2
      with:
        repository: mseninc/blog-gatsby

    - name: Checkout
      uses: actions/checkout@v2
      with:
        path: content

    - name: Caching Gatsby
      id: gatsby-cache-build
      uses: actions/cache@v2
      with:
        path: |
          public
          .cache
        key: ${{ runner.os }}-gatsby-build
        restore-keys: |
          ${{ runner.os }}-gatsby-build
    
    - run: ls -la

    - name: Node
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        cache: npm

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: node_modules/.bin/gatsby build --verbose --prefix-paths

    - name: Deploy post files
      run: "aws s3 sync public s3://msen-blog-preview/${BRANCH_NAME} --exclude '*' --include '*.html' --include '*/app-data.json' --include '*/page-data.json' --delete"

    - name: Deploy other files
      run: "aws s3 sync public s3://msen-blog-preview/${BRANCH_NAME} --size-only --exclude '*.html' --exclude '*/app-data.json' --exclude '*/page-data.json' --delete"
