---
title: "[Linux] too many open files エラーの対処方法と恒久的な解決策"
date: 
author: Ryotaro49
tags: [Linux, Ubuntu Server 22.04, Ubuntu]
description: "Linux システムで `too many open files` エラーに対処する方法を解説します。`ulimit` コマンドを使った一時的な対策と `/etc/security/limits.conf` を編集して恒久的に設定する方法を紹介します。"  
---

`too many open files` というエラーは、一度に開けるファイルの数の制限に達したとき発生します。

私は `manta` の使用時、この問題に直面しましたが、`ulimit` コマンドで一時的に解決し、後に恒久的な設定を適用して問題を解消しました。

この記事では、以下の環境で動作確認を行っています。

- Ubuntu Server 22.04.3 LTS
- Python 2.7.18
- manta 1.6.0

## `too many open files` エラーの原因

このエラーは、システムが一度に開けるファイルの最大数を超えると発生します。

制限には次の2つがあります。

- **ソフトリミット**: ユーザーが設定できる最大のファイル数。通常の操作ではこの値が制限として働きます。
- **ハードリミット**: システム全体の上限。この上限はシステム管理者が定め、ソフトリミットの最大値を制約します。

## 一時的な対処法

一時的にこの問題を解決するために、まずは現在のハードリミットとソフトリミットを確認し、`ulimit` コマンドでソフトリミットを変更します。

### ソフトリミットとハードリミットの確認

以下のコマンドでソフトリミットとハードリミットを確認します。

```bash:title=ソフトリミットを確認
$ ulimit -Sn
```

```bash:title=ハードリミットを確認
$ ulimit -Hn
```

私のシステムでは、ソフトリミットの値が `1024` 、ハードリミットの値が `1048576` でした。

つまり、現在ユーザーが開けるファイルの最大数が 1024 で、ユーザーが設定できるファイルの最大数が 1048576 です。

### ソフトリミットの変更

次に、ソフトリミットを必要な値に設定します。

私の場合は最大値に設定しました。

```bash:title=ソフトリミットを設定
$ ulimit -Sn 1048576
```

このコマンドにより、`manta` のようなリソースを大量に使用するアプリケーションでも正常に動作するようになりました。

## 恒久的な対策

`ulimit` コマンドでの設定はシステムを再起動するとリセットされてしまいます。

そのため、恒久的な解決策として、`/etc/security/limits.conf` を編集する必要があります。

### 設定手順

1. 以下のコマンドで `limits.conf` を開きます。

```bash:title=limits.confを開く
$ sudo vi /etc/security/limits.conf
```

2. 次に、以下の行を追加してソフトリミットを設定します。

```bash:title=ソフトリミットの指定を追加
* soft nofile 1048576
```

ここで、`*` はすべてのユーザーに適用されます。

特定のユーザーに適用したい場合は、そのユーザー名を指定します。

### 設定の反映確認

設定後、再ログインして次のコマンドを実行します。

```bash:title=ソフトリミットとハードリミットの確認
$ ulimit -Sn
$ ulimit -Hn
```

これでソフトリミットとハードリミットが正しく設定されていれば、恒久的な設定は完了です。

## まとめ

`too many open files` エラーは、特に多くのファイルを扱うアプリケーションを実行する際に発生しやすい問題です。

`ulimit` コマンドで一時的に解決可能ですが、恒久的な設定には `limits.conf` の修正が必要です。

この記事が、同じ問題に直面した方々の役に立てば幸いです。

それではまた！

## 参考文献
- Linux `ulimit` ドキュメント  
