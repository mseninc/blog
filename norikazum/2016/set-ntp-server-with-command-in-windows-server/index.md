---
title: コマンドでWindows ServerのNTPサーバーを設定する
date: 2016-07-27
author: norikazum
tags: [Windows Server, Windows]
---

こんにちは。

ポケモンGOの話題が盛んな中、普通にインフラ記事を書いてしまう社長です。

今回は、Windows Serverが参照するNTPサーバーをコマンドで設定する方法を紹介します。

Windows Serverの設定をしていると、**「NTP同期ってちゃんとできてるのかな？」** や、**「NTPサーバーって設定したかな？」**となることがあるかと思います。（私は結構あります汗）

## w32tm コマンドの前提
次項に進む前に、今回は**w32tm**というコマンドを利用して確認・設定を進めますが、以下の前提があります。

W32timeサービスの標準の動作として ActiveDirectory ドメイン環境に属しているかどうかにより起動か停止が判定されます。

つまり、ActiveDirectory ドメイン環境に属している場合は、トリガー起動サービスによって Windows Time サービスが開始され、ActiveDirectory ドメインに属していない場合は、Windows Time サービスが停止されます。

ドメイン環境に属していない場合には以下の回避策を検討の上、次項にお進み下さい。

`sc triggerinfo w32time delete` を実行してトリガーを削除する、

もしくは、

**Windows Time サービスのスタートアップの種類を [手動] から [自動 (遅延開始)] に変更**　する。


## まずは確認
コマンドプロンプトを開き、**w32tm /query /status** のコマンドで確認します。

```
C:\Users\Administrator>w32tm /query /status
閏インジケーター: 0 (警告なし)
階層: 1 (主参照 - 電波時計で同期)
精度: -6 (ティックごとに 15.625ms)
ルート遅延: 0.0000000s
ルート分散: 10.0000000s
参照 ID: 0x4C4F434C (ソース名:  "LOCL")
最終正常同期時刻: 2016/07/23 21:45:42
ソース: Free-running System Clock
ポーリング間隔: 6 (64s)
```

**ソース**の部分がコマンドを実行した時点で設定されている参照NTPサーバーで、上記は**Free-running System Clock**となっています。

これは、**サーバーのハードウェアが刻んでいる内蔵時計と時刻同期してるよ**という意味になりNTPサーバーの指定はできていないことを示します。

## 参照NTPサーバーを設定

今回は、NICT (独立行政法人情報通信研究機構)が公開しているNTPサーバーを参照します。

**w32tm /config /syncfromflags:manual /manualpeerlist:<span style="color:red;">ntp.nict.jp</span> /update** のコマンドで設定します。

赤字の部分を、設定したい参照NTPサーバーのDNS名やIPアドレスに書き換えてください。

実行結果は以下のような形になります。
```
C:\Users\Administrator>w32tm /config /syncfromflags:manual /manualpeerlist:ntp.nict.jp /update
コマンドは正しく完了しました。
```

## 同期と確認
設定が無事完了したところで、**w32tm /resync** のコマンドを使って同期を実行します。

```
C:\Users\Administrator>w32tm /resync
再同期コマンドをローカル コンピューターに送信しています
コマンドは正しく完了しました。
```

無事完了しましたね。

念のため、再度確認を実施しておきます。

```
C:\Users\Administrator>w32tm /query /status
閏インジケーター: 0 (警告なし)
階層: 2 (二次参照 - (S)NTP で同期)
精度: -6 (ティックごとに 15.625ms)
ルート遅延: 0.0312500s
ルート分散: 7.7756259s
参照 ID: 0x85F3EEA3 (ソース IP:  133.243.238.163)
最終正常同期時刻: 2016/07/24 4:37:56
ソース: ntp.nict.jp
ポーリング間隔: 6 (64s)
```

ソースの部分が変更されていて、正しく参照NTPサーバーが書き換わりました。

以降は、ポーリング間隔に表示されている間隔で時刻同期が行われます。

## あとがき

今回、NTP参照サーバーに使わせていただいたNICT、なんと読むかご存じでしょうか？

基本的には、**「エヌ・アイ・シーティ」** と読むようです。そのままですね。

**「ニクト」** とも読んでしまいたくなるかもしれませんが、この表現はスラングのようで、私も以前、この表現で発言してしまい、関係者に注意されたことがあります。

なんのスラングか調べてみたのですがはっきりは出てこず、スターウォーズに出てくるヒューマノイド型知覚種族が同じ呼び方ということを指しているのかもしれない、という記事を目にしたことがある程度でした。[参照](http://ja.starwars.wikia.com/wiki/%E3%83%8B%E3%82%AF%E3%83%88)

事実、NICTが発行する[記事中](http://www.nict.go.jp/publication/NICT-News/1104/01.html)や、電話の受付で名乗る名称は「エヌ・アイ・シーティ」で統一されているようです。

参考になれば幸いです。
また次の記事でお会いしましょう。